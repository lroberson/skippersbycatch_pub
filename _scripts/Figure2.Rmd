---
title: "Figure2"
author: "Leslie Roberson"
date: "28/01/2022"
output: html_document
---

## Summary

This is the data and code needed to reproduce the raw version of Figure 2 (plot of vessel regression coefficients). Note that the vessel IDs have been anonymized (again) and do not match the anonymous IDs used in other figures

Final formatting (fonts, bycatch species icons, legend titles, extra legend with "good" and "bad" arrows) was done in Adobe Illustrator.

```{r setup, include=FALSE}

library(tidyverse)
library(pillar)
library(purrr)
library(forcats)
library(cowplot)
library(ggrepel)
library(scales)

knitr::opts_chunk$set(echo = TRUE)
```

## Load and prep data

```{r prep data}

fig2.dat <- read_csv(here("_data/fig2_dat.csv"))
glimpse(fig2.dat)
# reg.coeff: value of regression coefficient for each vessel in each model
# species: one of eight bycatch species or groups
# fishery_lab_lab: name of fishery_lab as used in teh manuscripts (not the fishery_lab's official name)
# vessel_id: anonymised identifier for individual vessels
# coeff_norm: regression coefficient normalized -1 to 1
# rank_coeff: rank of reg coefficients within each fishery_lab
n_distinct(fig2.dat$vessel_id) # 300
# NB there are 305 vessels, but one vessel is lost in calculation of regression coefficients in each model (even when using contrast treatment)

##<>< Make factors
# fishery_lab
unique(fig2.dat$fishery_lab)
fig2.dat$fishery_lab <- as_factor(fig2.dat$fishery_lab)
fig2.dat <- fig2.dat %>%
  # reorder levels so the 3 SESSF subsectors are on top and the other 2 fisheries on the bottom
  mutate(fishery_lab=fct_relevel(fishery_lab, levels=c("set_gillnets", "demersal_longlines",  "otter_bottom_trawl", "tuna_longlines", "prawn_trawl"))) # ignore warning

# bycatch type
unique(fig2.dat$bycatch_spp)
fig2.dat$bycatch_spp <- as_factor(fig2.dat$bycatch_spp)
fig2.dat <- fig2.dat %>%
  mutate(bycatch_spp = stringr::str_to_sentence(bycatch_spp)) %>%
  mutate(bycatch_spp=fct_recode(bycatch_spp, "Shortfin makos"="Shortfin_makos"),
         # put in alphabetical order
         bycatch_spp=fct_relevel(bycatch_spp,                                         levels=c("Albatrosses","Dolphins","Hammerheads","Petrels","Pinnipeds","Seasnakes","Shearwaters","Shortfin makos")))

##<>>< make color palette
pal_distinct8 <- c("#0073D2FF","#8F7700FF","#7876B1FF","#61221a","#CD534CFF","#272928","#EFC000FF","#868686FF")

```

## Plot
Use dot size to show magnitude of standard error

```{r fig2 plot}

fig2.plot <- fig2.dat %>%
    ggplot(aes(x=reorder(rank_coeff, -rank_coeff), y=coeff_norm)) +
    geom_line(aes(group=species, color=species)) +
    # show the data points on the line
    geom_point(aes(color=species, size=SE)) +
    scale_color_manual(values = pal_distinct8) +
    facet_wrap(~fishery_lab, nrow=2, scale="free_x") + # only show y axis on left
    scale_y_continuous(expand=c(0.05, 0.05)) +
    scale_x_discrete(expand=c(0.1,0.1)) +
    geom_hline(yintercept = 0, size=0.3, color="black") +
    labs(x="Vessel rank", y="Coefficient") +
    theme(panel.grid = element_blank(),
          panel.background = element_rect(fill = NA, color = "black"),
          strip.background = element_rect(fill = "white", color="black"),
          legend.position = c(0.83, 0.28),
          legend.title=element_blank(),
          legend.key = element_rect(fill = NA),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank()) +  # keep ticks to show how many vessels there are
    guides(color=guide_legend(override.aes = list(size = 3)),
           size=FALSE) # don't show legend for SE 

fig2.plot

```

