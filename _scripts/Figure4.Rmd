---
title: "Figure4"
author: "Leslie Roberson"
date: "28/01/2022"
output: html_document
---

## Summary

This is the data and code needed to reproduce the raw version of Figure 4 (bycatch to target ratio of vesseby year). Only the aggregate summary of data is provided (no shot-level data), as per the Deed of Confidentiality with AFMA

Note that final formatting (fonts, bycatch species icons, custom x-axis labels) was done in Adobe Illustrator.

```{r setup, include=FALSE}

library(tidyverse)
library(pillar)
library(here)
library(stringr)
library(cowplot)
library(ggrepel)
library(scales)
library(plotrix)
library(ggthemes)

knitr::opts_chunk$set(echo = TRUE)
```

## aggregate data

```{r aggregate}

fig4.dat <- read_csv(here("_data/fig4_dat.csv")) # not publicly available
glimpse(fig4.dat)
# shot_id: anonymous ID of fishing event (setting and hauling gear)
# year: year
# target_catch: count or weight(kg) of main target species, depending on the fishery
# bycatch_spp: one of eight bycatch species or groups
# bycatch_cnt: bycatch count (individual animals) 
# fishery: name of fishery as used in teh manuscripts (not the fishery's official name)
# vessel_id: anonymised identifier for individual vessels

fig4.dat.v2 <- fig4.dat %>% 
    group_by(fishery, shot_id, bycatch_spp) %>%
    # adjust zeros for log scale
    mutate(target_catch=ifelse(target_catch==0, 0.1, target_catch),
           byc_ratio = bycatch_cnt/target_catch) %>%
    ungroup() %>%
    group_by(fishery, year, vessel_id, bycatch_spp) %>%
    summarise(avg_ratio=mean(byc_ratio)) %>%
    ungroup()

write_csv(fig4.dat.v2, here("_data/fig4_dat_v2.csv"))
```

## load and prep data

```{prep data}
  
fig4.dat.v2 <- read_csv(here("_data/fig4_dat_v2.csv"))

##<>< Make factors
# fishery
unique(fig4.dat.v2$fishery)
fig4.dat.v2$fishery <- as_factor(fig4.dat.v2$fishery)
fig4.dat.v2 <- fig4.dat.v2 %>%
  # reorder levels so the 3 SESSF subsectors are on top and the other 2 fisheries on the bottom
  mutate(fishery=fct_relevel(fishery, levels=c("set_gillnets", "demersal_longlines",  "otter_bottom_trawl", "tuna_longlines", "prawn_trawl"))) # ignore warning

# bycatch type
unique(fig4.dat.v2$bycatch_spp)
fig4.dat.v2$bycatch_spp <- as_factor(fig4.dat.v2$bycatch_spp)
fig4.dat.v2 <- fig4.dat.v2 %>%
  mutate(bycatch_spp = stringr::str_to_sentence(bycatch_spp)) %>%
  mutate(bycatch_spp=fct_recode(bycatch_spp, "Shortfin makos"="Shortfin_makos"),
         # put in alphabetical order
         bycatch_spp=fct_relevel(bycatch_spp,                                         levels=c("Albatrosses","Dolphins","Hammerheads","Petrels","Pinnipeds","Seasnakes","Shearwaters","Shortfin makos")))
levels(fig4.dat.v2$bycatch_spp)

##<>>< make color palette
pal_distinct8 <- c("#0073D2FF","#8F7700FF","#7876B1FF","#61221a","#CD534CFF","#272928","#EFC000FF","#868686FF")

```

## make plot
1 row x 5 cols

```{r fig4 plot}

glimpse(fig4.dat.v2)

fig4.plot <- fig4.dat.v2 %>% 
    ggplot(aes(x=year, y=avg_ratio, color=bycatch_spp)) +
    geom_point(aes(x=year, y=avg_ratio, color=bycatch_spp), 
               size=1.5, alpha=0.8) + 
    scale_color_manual(values = pal_distinct8) +
    facet_wrap(~fishery, nrow=1, scales= "free") + 
    scale_y_continuous(trans="pseudo_log", breaks=pretty_breaks(n=6)) + 
    labs(x = "Year", y = "Bycatch to target ratio") +
    theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.title= element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.x = element_text(color="white"), # add first and last year in illustrator, but leave space below axis
        legend.position="top", # for 1 row
        strip.background =element_rect(fill="NA", color ="black"), # facet label boxes fill white instead of gray
        panel.border = element_rect(fill = NA, color = "black"), # keep facet label borders
        legend.key = element_rect(fill = NA)) + 
    guides(color = guide_legend(override.aes = list(size = 3)))

fig4.plot

```

