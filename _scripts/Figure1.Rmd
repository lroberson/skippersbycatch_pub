---
title: "Figure1"
author: "Leslie Roberson"
date: "28/01/2022"
output: html_document
---

## Summary

This is the data and code needed to reproduce the raw version of Figure 1 (average target and bycatch of vessels over the time period of the data). Only the aggregate summary of data is provided, as per the Deed of Confidentiality with AFMA

Note that final formatting (fonts, bycatch species icons) was done in Adobe Illustrator.

```{r setup, include=FALSE}

library(tidyverse)
library(pillar)
library(here)
library(stringr)
library(cowplot)
library(ggrepel)
library(scales)
library(plotrix)
library(ggthemes)

knitr::opts_chunk$set(echo = TRUE)
```

## Aggregate data

```{r aggregate}

fig1.dat <- read_csv(here("_data/fig1_dat.csv")) # not publicly available
glimpse(fig1.dat)

fig1.dat2 <- fig1.dat %>%
    distinct(fishery, vessel_id, shot_id, target_catch, bycatch_spp, bycatch_cnt) %>%
    group_by(fishery, vessel_id, bycatch_spp) %>%
    summarise(avg_target = mean(target_catch),
              se_target= plotrix::std.error(target_catch),
              avg_bycatch = mean(bycatch_cnt),
              se_bycatch = plotrix::std.error(bycatch_cnt)) 
glimpse(fig1.dat2)

fig1.dat2 %>%
  group_by(fishery) %>%
  summarise(n_vsl=n_distinct(vessel_id))

write_csv(fig1.dat2, here("_data/fig1.dat2.csv"))

```

## load and prep data

```{r data prep}

fig1.dat2 <- read_csv(here("_data/fig1.dat2.csv"))
glimpse(fig1.dat2)
# fishery: name of fishery as used in teh manuscripts (not the fishery's official name)
# vessel_id: anonymised identifier (count) for individual vessels
# bycatch_spp: one of eight bycatch species or groups
# avg_target: mean count or weight(kg) of main target species, depending on the fishery, per fishing event for each vessel over all years of data
# se_target: standard error of mean target catch
# avg_bycatch: mean count of bycatch species per fishing event for each vessel over all years of data
# se_bycatch: standard error of mean bycatch 

##<>< Make factors
# fishery
unique(fig1.dat2$fishery)
fig1.dat2$fishery <- as_factor(fig1.dat2$fishery)
fig1.dat2 <- fig1.dat2 %>%
  # reorder levels so the 3 SESSF subsectors are on top and the other 2 fisheries on the bottom
  mutate(fishery=fct_relevel(fishery, levels=c("set_gillnets", "demersal_longlines",  "otter_bottom_trawl", "tuna_longlines", "prawn_trawl"))) # ignore warning
# bycatch type
unique(fig1.dat2$bycatch_spp)
fig1.dat2$bycatch_spp <- as_factor(fig1.dat2$bycatch_spp)

fig1.dat2 <- fig1.dat2 %>%
  mutate(bycatch_spp = stringr::str_to_sentence(bycatch_spp)) %>%
  mutate(bycatch_spp=fct_recode(bycatch_spp, "Shortfin makos"="Shortfin_makos"),
         # put in alphabetical order
         bycatch_spp=fct_relevel(bycatch_spp,                                         levels=c("Albatrosses","Dolphins","Hammerheads","Petrels","Pinnipeds","Seasnakes","Shearwaters","Shortfin makos")))

##<>>< make color palette
pal_distinct8 <- c("#0073D2FF","#8F7700FF","#7876B1FF","#61221a","#CD534CFF","#272928","#EFC000FF","#868686FF")

```

## Make plot
5 panel facet plot

```{r fig1 plot}
glimpse(fig1.dat2)

fig1.plot <- fig1.dat2 %>%
    group_by(fishery, vessel_id, bycatch_spp) %>%
    ggplot(aes(x=avg_target, y=avg_bycatch, color=bycatch_spp)) +
    geom_errorbar(aes(x=avg_target, y=avg_bycatch, ymin=avg_bycatch-se_bycatch, ymax=avg_bycatch+se_bycatch, color=bycatch_spp), alpha = 0.8, size=0.2) +
    geom_errorbar(aes(x=avg_target, y=avg_bycatch, xmin=avg_target-se_target, xmax=avg_target+se_target, color=bycatch_spp), alpha = 0.8, size=0.2) +
    geom_jitter(aes(color=bycatch_spp), alpha=0.8) +
    scale_color_manual(values = pal_distinct8) +
    facet_wrap(~fishery, nrow=2, scales= "free") + 
    scale_x_continuous(expand=c(0.1, 0.1)) +
    scale_y_continuous(expand=c(0.05, 0)) +
    labs(x = "Average target catch (individuals or kg)", y = "Average bycatch (individuals)") +
    theme(panel.grid = element_blank(),
          panel.background = element_rect(fill = NA, color = "black"),
          strip.background = element_rect(fill = "white", color="black"),
          legend.position = c(0.83, 0.25), # if doing 2 rows
          legend.title=element_blank(),
          legend.key = element_rect(fill = NA)
          )
fig1.plot

```

